---
phase: 01-diagnostic-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/debug/mod.rs
  - src/debug/weight_diagnostics.rs
  - src/inference/pipeline.rs
  - src/main.rs
  - src/models/vocoder/bigvgan.rs
  - src/models/gpt/conformer.rs
  - src/models/gpt/perceiver.rs
  - src/models/semantic/wav2vec_bert.rs
  - src/models/s2mel/dit.rs
autonomous: true

must_haves:
  truths:
    - "Running inference with --verbose prints tensor names from each safetensors file"
    - "Running inference with --verbose prints which tensors were found vs missing for each component"
    - "Missing tensors produce visible tracing::warn! warnings (not silent fallback)"
  artifacts:
    - path: "src/debug/weight_diagnostics.rs"
      provides: "WeightDiagnostics struct and ComponentReport"
      exports: ["WeightDiagnostics", "ComponentReport"]
    - path: "src/debug/mod.rs"
      provides: "Re-exports weight_diagnostics module"
      contains: "pub use weight_diagnostics"
    - path: "src/inference/pipeline.rs"
      provides: "InferenceConfig with verbose_weights field"
      contains: "verbose_weights: bool"
  key_links:
    - from: "src/main.rs"
      to: "InferenceConfig"
      via: "cli.verbose -> inference_config.verbose_weights"
      pattern: "verbose_weights.*cli\\.verbose|verbose.*verbose_weights"
    - from: "src/models/vocoder/bigvgan.rs"
      to: "WeightDiagnostics"
      via: "load_weights uses diagnostics"
      pattern: "WeightDiagnostics|tracing::warn"
---

<objective>
Create diagnostic infrastructure to expose silent weight loading failures across all model components.

Purpose: Without diagnostics, tensor name mismatches cause silent fallback to random weights, producing noise instead of speech. This plan adds visibility so subsequent weight-fixing phases can validate their work.

Output:
- `WeightDiagnostics` struct that tracks found/missing tensors per component
- `verbose_weights` flag propagated from CLI to weight loading
- All silent `unwrap_or_else` fallbacks converted to `tracing::warn!` warnings
</objective>

<execution_context>
@C:\Users\Henri Smith\.claude-membership/get-shit-done/workflows/execute-plan.md
@C:\Users\Henri Smith\.claude-membership/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-diagnostic-infrastructure/01-RESEARCH.md
@src/debug/mod.rs
@src/models/vocoder/weights.rs
@src/inference/pipeline.rs
@src/main.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WeightDiagnostics module</name>
  <files>src/debug/weight_diagnostics.rs, src/debug/mod.rs</files>
  <action>
Create `src/debug/weight_diagnostics.rs` with:

1. `ComponentReport` struct:
   - `component_name: String`
   - `file_path: String`
   - `available_keys: Vec<String>` (all keys in safetensors file)
   - `expected_keys: HashSet<String>` (keys the component tried to load)
   - `found_keys: HashSet<String>` (intersection)
   - `missing_keys: HashSet<String>` (expected - found)
   - Method `success_rate(&self) -> f32` returning found/expected ratio
   - Method `print_summary(&self)` that uses `eprintln!` to show component name, file path, counts, and first 10 missing keys

2. `WeightDiagnostics` struct:
   - `verbose: bool` field
   - `reports: Vec<ComponentReport>` field
   - `fn new(verbose: bool) -> Self`
   - `fn load_safetensors<P: AsRef<Path>>(&mut self, path: P, component_name: &str, device: &Device) -> Result<HashMap<String, Tensor>>` that:
     - Calls `candle_core::safetensors::load(path, device)`
     - If verbose, prints tensor count and first 5 keys
     - Returns the HashMap
   - `fn record_component(&mut self, component_name: &str, file_path: &str, available_keys: Vec<String>, expected_keys: HashSet<String>)` that:
     - Computes found/missing/extra keys
     - Creates ComponentReport
     - If verbose OR missing_keys non-empty, calls print_summary()
     - Pushes report to self.reports
   - `fn print_final_summary(&self)` that prints OK/MISSING status for each component

3. Update `src/debug/mod.rs`:
   - Add `mod weight_diagnostics;`
   - Add `pub use weight_diagnostics::{WeightDiagnostics, ComponentReport};`

Use `std::collections::{HashMap, HashSet}`, `candle_core::{Device, Tensor, safetensors}`, `anyhow::Result`, `std::path::Path`.
  </action>
  <verify>
`cargo check --lib` compiles without errors. Grep for `WeightDiagnostics` in src/debug/mod.rs shows re-export.
  </verify>
  <done>
WeightDiagnostics and ComponentReport structs exist with all methods. Module is exported from debug/mod.rs.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add verbose_weights to InferenceConfig and CLI</name>
  <files>src/inference/pipeline.rs, src/main.rs</files>
  <action>
1. In `src/inference/pipeline.rs`, add to `InferenceConfig` struct:
   ```rust
   /// Enable verbose weight loading diagnostics
   pub verbose_weights: bool,
   ```
   And in `Default` impl, add:
   ```rust
   verbose_weights: false,
   ```

2. In `src/main.rs`:
   - In the `Commands::Infer` match arm, when creating `inference_config`, add:
     ```rust
     verbose_weights: cli.verbose,
     ```
   - This propagates the existing `--verbose` flag to weight diagnostics

The `--verbose` flag already exists in CLI (`#[arg(short, long, global = true)]`), so no CLI changes needed.
  </action>
  <verify>
`cargo check --bin indextts2` compiles. Run `cargo run --release --bin indextts2 -- --help` and confirm `--verbose` flag is shown.
  </verify>
  <done>
InferenceConfig has verbose_weights field. CLI --verbose flag propagates to inference_config.verbose_weights.
  </done>
</task>

<task type="auto">
  <name>Task 3: Replace silent fallbacks with tracing::warn! across model loaders</name>
  <files>src/models/gpt/conformer.rs, src/models/gpt/perceiver.rs, src/models/semantic/wav2vec_bert.rs, src/models/s2mel/dit.rs, src/models/vocoder/bigvgan.rs</files>
  <action>
Find all `unwrap_or_else` patterns that silently create random/zero tensors when keys are missing. Replace them with explicit warnings using `tracing::warn!`.

Pattern to find: `.unwrap_or_else(|| Tensor::randn(...` or `.unwrap_or_else(|| Tensor::zeros(...` or `.unwrap_or_else(|| Tensor::ones(...`

Replace with helper function pattern:
```rust
fn get_tensor_with_fallback(
    tensors: &HashMap<String, Tensor>,
    key: &str,
    fallback: impl FnOnce() -> Tensor,
    component: &str,
) -> Tensor {
    match tensors.get(key) {
        Some(t) => t.clone(),
        None => {
            tracing::warn!(
                "[{}] Missing tensor '{}', using random/zero initialization",
                component, key
            );
            fallback()
        }
    }
}
```

For each file:

1. `src/models/gpt/conformer.rs`:
   - Line ~58-62: layer_norm weight/bias fallbacks (add warn)
   - Line ~409-413: depthwise_conv weight/bias fallbacks (add warn)
   - Add component name "Conformer" to warnings

2. `src/models/gpt/perceiver.rs`:
   - Line ~311-322: MLP linear fallbacks (add warn)
   - Add component name "Perceiver" to warnings

3. `src/models/semantic/wav2vec_bert.rs`:
   - Line ~66-70: layer_norm fallbacks (add warn)
   - Line ~437-440: mean/std stats fallbacks (add warn)
   - Add component name "Wav2Vec-BERT" to warnings

4. `src/models/s2mel/dit.rs`:
   - Line ~135: RMSNorm weight fallback (add warn)
   - Lines ~247-258, ~487-488, ~676-696, ~1031: various MLP/linear fallbacks (add warn)
   - Add component name "DiT" to warnings

5. `src/models/vocoder/bigvgan.rs`:
   - Check if any silent fallbacks exist (research shows BigVGAN uses explicit error handling, but verify)
   - If any found, add warnings

IMPORTANT: Do NOT change the fallback behavior (still create random/zero tensors), only ADD the warning before returning the fallback.

Use `tracing::warn!` (already imported in most files, add if missing).
  </action>
  <verify>
`cargo build --release` compiles. Run inference with a simple test and observe warnings appear for any missing tensors:
```bash
cargo run --release --bin indextts2 -- --verbose --cpu infer --text "Test" --speaker checkpoints/speaker_16k.wav --output /tmp/test.wav 2>&1 | grep -i "missing tensor"
```
If weights are properly loaded, no warnings appear. If weights are missing, warnings show which tensors.
  </verify>
  <done>
All silent unwrap_or_else fallbacks now emit tracing::warn! before returning fallback tensor. Running inference shows warnings for any missing tensors.
  </done>
</task>

</tasks>

<verification>
1. **Compilation check:**
   ```bash
   cargo build --release 2>&1 | grep -E "error|warning: unused"
   ```
   Should show no errors. Warnings about unused code are acceptable for now.

2. **Unit test:**
   ```bash
   cargo test weight_diagnostics
   ```
   Should pass (add basic test if none exist).

3. **Integration check (verbose mode):**
   ```bash
   cargo run --release --bin indextts2 -- --verbose --cpu infer \
     --text "Hello" \
     --speaker checkpoints/speaker_16k.wav \
     --output /tmp/diag_test.wav 2>&1 | head -100
   ```
   Should show:
   - Tensor loading messages with counts
   - Any missing tensor warnings
   - Weight loading summary

4. **Non-verbose mode:**
   ```bash
   cargo run --release --bin indextts2 -- --cpu infer \
     --text "Hello" \
     --speaker checkpoints/speaker_16k.wav \
     --output /tmp/diag_test.wav 2>&1 | grep -c "Missing tensor"
   ```
   Should still show warnings for missing tensors (even without --verbose, warnings should appear).
</verification>

<success_criteria>
1. WeightDiagnostics module exists and exports correctly
2. InferenceConfig.verbose_weights field exists and propagates from CLI
3. All ~20 silent unwrap_or_else fallbacks now emit tracing::warn!
4. Running inference with --verbose shows tensor enumeration
5. Running inference shows warnings for any missing tensors (regardless of --verbose)
6. cargo build --release succeeds
7. cargo test passes
</success_criteria>

<output>
After completion, create `.planning/phases/01-diagnostic-infrastructure/01-01-SUMMARY.md` using the summary template.
</output>

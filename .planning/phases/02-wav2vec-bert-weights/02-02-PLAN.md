---
phase: 02-wav2vec-bert-weights
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/models/semantic/wav2vec_bert.rs
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Stats file var is converted to std via sqrt() at load time"
    - "Relative position bias is added to attention scores"
    - "Distance embedding [73, 64] loaded per layer from checkpoint"
    - "No 'using random weights' warnings for Wav2Vec-BERT components"
  artifacts:
    - path: "src/models/semantic/wav2vec_bert.rs"
      provides: "var to std conversion in load_stats"
      contains: "sqrt()"
    - path: "src/models/semantic/wav2vec_bert.rs"
      provides: "distance_embedding field in SelfAttention"
      contains: "distance_embedding"
  key_links:
    - from: "load_stats"
      to: "var tensor"
      via: "sqrt conversion"
      pattern: "var.*sqrt"
    - from: "SelfAttention::forward"
      to: "distance_embedding"
      via: "relative position bias"
      pattern: "distance.*broadcast"
---

<objective>
Implement distance_embedding (relative position encoding) and fix stats var->std conversion

Purpose: The checkpoint stores variance (var) but code expects std. The attention layers also include distance_embedding for Shaw-style relative positions that isn't currently loaded or used. These are the remaining components for complete Wav2Vec-BERT weight loading.

Output: Updated wav2vec_bert.rs with var->std conversion and relative position bias in attention.
</objective>

<execution_context>
@C:\Users\Henri Smith\.claude-membership/get-shit-done/workflows/execute-plan.md
@C:\Users\Henri Smith\.claude-membership/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-wav2vec-bert-weights/02-CONTEXT.md
@.planning/phases/02-wav2vec-bert-weights/02-RESEARCH.md
@.planning/phases/02-wav2vec-bert-weights/02-01-SUMMARY.md
@src/models/semantic/wav2vec_bert.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix stats file var to std conversion</name>
  <files>src/models/semantic/wav2vec_bert.rs</files>
  <action>
Update `load_stats()` to handle var -> std conversion.

Current stats file (checkpoints/wav2vec2bert_stats.safetensors) contains:
- `mean`: [1024] - correct as-is
- `var`: [1024] - needs sqrt() to become std

Update the loading logic:
```rust
let std = match tensors.get("std") {
    Some(s) => s.clone(),
    None => match tensors.get("var") {
        Some(var) => {
            // Convert variance to standard deviation
            var.sqrt()?
        }
        None => {
            tracing::warn!(
                "[Wav2Vec-BERT] Missing 'std' or 'var' in stats file, using ones initialization"
            );
            Tensor::ones((HIDDEN_SIZE,), DType::F32, device)?
        }
    }
};
```

This tries `std` first (for future compatibility), then converts `var` via sqrt(), then falls back to ones with warning.
  </action>
  <verify>
cargo build --release 2>&1 | grep -E "error"
# No compilation errors

# If weights available, running inference should NOT show "using ones initialization" warning for std
  </verify>
  <done>
load_stats() converts var to std via sqrt(). Prioritizes std key, falls back to var with conversion, then warns and uses ones.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement distance_embedding (relative position encoding)</name>
  <files>src/models/semantic/wav2vec_bert.rs</files>
  <action>
Add distance_embedding to SelfAttention for Shaw-style relative position encoding.

Constants (from HuggingFace config):
```rust
const LEFT_MAX_POS: i64 = 64;
const RIGHT_MAX_POS: i64 = 8;
const NUM_POSITIONS: usize = 73;  // 64 + 8 + 1
```

Update SelfAttention struct:
```rust
struct SelfAttention {
    query: Linear,
    key: Linear,
    value: Linear,
    output: Linear,
    num_heads: usize,
    head_dim: usize,
    distance_embedding: Option<Tensor>,  // [73, 64] per layer
}
```

In from_tensors(), load distance embedding:
```rust
let distance_key = format!("{}.distance_embedding.weight", prefix);
let distance_embedding = tensors.get(&distance_key).cloned();
if distance_embedding.is_none() {
    tracing::warn!(
        "[Wav2Vec-BERT] Missing tensor '{}', skipping relative position bias",
        distance_key
    );
}
```

Add helper function for position bias:
```rust
fn compute_relative_position_bias(
    query: &Tensor,           // [batch, heads, query_len, head_dim]
    distance_embedding: &Tensor,  // [73, 64]
    device: &Device,
) -> Result<Tensor>
```

Algorithm:
1. Create position indices: pos_l [Q, 1], pos_r [1, K]
2. Compute distance: pos_r - pos_l -> [Q, K]
3. Clamp to [-64, 8] range
4. Shift to positive: distance + 64 -> indices in [0, 72]
5. Lookup embeddings via index_select -> [Q, K, head_dim]
6. Compute bias via matmul with query: [batch, heads, Q, K]
7. Scale by 1/sqrt(head_dim)

In forward(), after computing attn_weights, add position bias:
```rust
let attn_weights = if let Some(ref dist_emb) = self.distance_embedding {
    let pos_bias = compute_relative_position_bias(&query, dist_emb, hidden_states.device())?;
    (attn_weights + pos_bias)?
} else {
    attn_weights
};
```

Handle new_random() by setting distance_embedding to None (no relative bias during random init).
  </action>
  <verify>
# No compilation errors
cargo build --release 2>&1 | grep -E "error"

# Test passes
cargo test test_semantic_encoder 2>&1

# CRITICAL: Verify distance_embedding field exists in SelfAttention struct
grep 'distance_embedding.*Option<Tensor>' src/models/semantic/wav2vec_bert.rs
# Must show the field declaration

# CRITICAL: Verify distance_embedding loading is attempted from checkpoint
grep -E 'distance_embedding.*weight|distance_key' src/models/semantic/wav2vec_bert.rs
# Must show tensor key being constructed and loaded

# Verify loading is attempted during inference (if checkpoint available)
cargo run --release --bin indextts2 -- --cpu infer --text 'test' --speaker checkpoints/speaker.wav --output /dev/null 2>&1 | grep -E '(distance_embedding|relative position)'
# Should show loading attempt (either success or "Missing tensor" warning)
  </verify>
  <done>
SelfAttention has distance_embedding field loaded from checkpoint. Forward pass adds relative position bias to attention scores. Graceful fallback when missing.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add unit test for stats conversion and relative position</name>
  <files>src/models/semantic/wav2vec_bert.rs</files>
  <action>
Add tests to verify the new functionality:

```rust
#[test]
fn test_var_to_std_conversion() {
    let device = Device::Cpu;
    // Create a tensor with variance values
    let var = Tensor::new(&[4.0f32, 9.0, 16.0], &device).unwrap();
    // sqrt should give std
    let std = var.sqrt().unwrap();
    let std_vals: Vec<f32> = std.to_vec1().unwrap();
    assert!((std_vals[0] - 2.0).abs() < 1e-5);
    assert!((std_vals[1] - 3.0).abs() < 1e-5);
    assert!((std_vals[2] - 4.0).abs() < 1e-5);
}

#[test]
fn test_relative_position_indices() {
    // Test that distance calculation produces correct range
    let device = Device::Cpu;
    let seq_len = 10i64;

    let pos_l = Tensor::arange(0i64, seq_len, &device).unwrap()
        .reshape((seq_len as usize, 1)).unwrap();
    let pos_r = Tensor::arange(0i64, seq_len, &device).unwrap()
        .reshape((1, seq_len as usize)).unwrap();

    let distance = pos_r.broadcast_sub(&pos_l).unwrap();
    let (q, k) = distance.dims2().unwrap();
    assert_eq!(q, 10);
    assert_eq!(k, 10);

    // Check diagonal is 0
    let diag: Vec<i64> = distance.i((0, 0)).unwrap().to_vec0().unwrap();
    assert_eq!(diag, 0);
}
```

These tests verify core math works correctly without needing actual checkpoint files.
  </action>
  <verify>
cargo test var_to_std 2>&1 | grep -E "(PASSED|FAILED)"
cargo test relative_position 2>&1 | grep -E "(PASSED|FAILED)"
# Both tests pass
  </verify>
  <done>
Unit tests for var->std conversion and relative position index calculation pass.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Build verification:
```bash
cargo build --release 2>&1 | grep -E "error"
# No errors
```

2. Test verification:
```bash
cargo test semantic 2>&1 | grep -E "(test.*PASSED|test.*FAILED|ok|failed)"
# All semantic tests pass
```

3. Stats conversion verification (if checkpoint available):
```bash
cargo run --release --bin indextts2 -- --cpu --verbose infer \
  --text "test" --speaker speaker.wav --output /dev/null 2>&1 | \
  grep -E "Wav2Vec-BERT.*std.*ones"
# Should NOT see "using ones initialization" for std if var exists
```

4. Distance embedding field verification:
```bash
grep 'distance_embedding.*Option<Tensor>' src/models/semantic/wav2vec_bert.rs
# Field must exist in SelfAttention struct
```
</verification>

<success_criteria>
- load_stats() converts var to std via sqrt()
- SelfAttention includes distance_embedding field (Option<Tensor>)
- distance_embedding loaded from checkpoint tensor `*.distance_embedding.weight`
- Relative position bias added to attention scores
- Unit tests for stats conversion and position indices pass
- Build succeeds with no errors
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-wav2vec-bert-weights/02-02-SUMMARY.md`
</output>

---
phase: 04-dit-weights
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/models/s2mel/dit.rs
autonomous: true
user_setup: []

must_haves:
  truths:
    - "DiT loads all 13 transformer blocks without 'using random weights' warnings"
    - "Weight normalization produces non-zero weights for x_embedder"
    - "Fused QKV split correctly into Q/K/V components"
    - "UViT skip connections use loaded skip_in_linear weights"
  artifacts:
    - path: "src/models/s2mel/dit.rs"
      provides: "DiTBlock with skip_in_linear field and loading"
      contains: "skip_in_linear"
  key_links:
    - from: "DiTBlock::from_tensors"
      to: "skip_in_linear.weight"
      via: "load_linear"
      pattern: "skip_in_linear.*weight"
---

<objective>
Add skip_in_linear to DiTBlock and verify all DiT weights load without fallback to random initialization.

Purpose: Complete the DiT weight loading so flow matching produces quality mel spectrograms instead of noise. The skip_in_linear component is required for UViT skip connections that concatenate encoder and decoder features.

Output: DiT that loads all 269 tensors from s2mel.safetensors with zero "using random weights" warnings.
</objective>

<execution_context>
@C:\Users\Henri Smith\.claude-membership/get-shit-done/workflows/execute-plan.md
@C:\Users\Henri Smith\.claude-membership/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase research identifies the gap
@.planning/phases/04-dit-weights/04-RESEARCH.md
@.planning/phases/04-dit-weights/04-CONTEXT.md

# Source file to modify
@src/models/s2mel/dit.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add skip_in_linear to DiTBlock</name>
  <files>src/models/s2mel/dit.rs</files>
  <action>
Add skip_in_linear field to DiTBlock struct and load it from checkpoint:

1. Update DiTBlock struct (around line 769):
```rust
struct DiTBlock {
    norm1: AdaLayerNorm,
    attn: MultiHeadAttention,
    norm2: AdaLayerNorm,
    ff: FeedForward,
    skip_in_linear: Option<Linear>,  // ADD: [512, 1024] for UViT skip connections
}
```

2. Update DiTBlock::new() to initialize skip_in_linear as None (random init path)

3. Update DiTBlock::from_tensors() to load skip_in_linear:
```rust
// After loading ff, add:
let skip_key = format!("{}.skip_in_linear.weight", prefix);
let skip_in_linear = match load_linear(
    tensors,
    &skip_key,
    Some(&format!("{}.skip_in_linear.bias", prefix)),
) {
    Ok(linear) => {
        // Only first block logs
        if prefix.ends_with(".0") {
            eprintln!("  Loaded skip_in_linear [512, 1024]");
        }
        Some(linear)
    }
    Err(_) => {
        tracing::warn!(
            "[DiT] Missing tensor '{}', skip connection disabled",
            skip_key
        );
        None
    }
};
```

4. Update DiTBlock::forward() to use skip_in_linear when available:
```rust
fn forward(&self, x: &Tensor, cond: &Tensor, skip: Option<&Tensor>) -> Result<Tensor> {
    // Apply skip_in_linear if we have skip connection input
    let x = if let (Some(ref linear), Some(skip_tensor)) = (&self.skip_in_linear, skip) {
        // Concatenate x with skip, then project back to hidden_dim
        let concat = Tensor::cat(&[x, skip_tensor], D::Minus1)?;
        linear.forward(&concat)?
    } else {
        x.clone()
    };

    // Rest of forward unchanged...
    let residual = x.clone();
    let x_normed = self.norm1.forward(&x, cond)?;
    // ... etc
}
```

Note: The UViT skip connection pattern feeds encoder outputs to corresponding decoder layers. For DiT's 13 layers (0-12), layers 7-12 receive skip connections from layers 5-0 respectively. Layer 6 is the middle layer with no skip.

This is a forward pass architecture change. For now, implement the loading and keep skip=None in forward calls. The actual skip connection wiring requires understanding the exact UViT pattern which may be deferred.
  </action>
  <verify>
Run: `cargo build --release 2>&1 | grep -E "(error|warning.*skip)" | head -20`
Expected: Compiles with no errors related to skip_in_linear
  </verify>
  <done>DiTBlock has skip_in_linear field that loads from checkpoint or warns if missing</done>
</task>

<task type="auto">
  <name>Task 2: Verify all DiT weights load without random fallback</name>
  <files>src/models/s2mel/dit.rs</files>
  <action>
Run inference and capture loading output to verify no "using random" warnings:

1. Run inference with tracing enabled:
```bash
RUST_LOG=warn cargo run --release --bin indextts2 -- --cpu infer \
  --text "Test" \
  --speaker "checkpoints/speaker_ref.wav" \
  --output "test_dit.wav" 2>&1 | tee dit_load.log
```

2. Check for random fallback warnings:
```bash
grep -i "random" dit_load.log
grep -i "using.*random" dit_load.log
grep -i "failed to load" dit_load.log
```

3. Verify loaded components (should see these in output):
- x_embedder (weight normalized)
- cond_projection
- cond_x_merge_linear [512, 864]
- t_embedder
- cond_embedder [1024, 512]
- 13 of 13 transformer blocks
- final norm
- skip_linear [512, 592]
- skip_in_linear [512, 1024] (per-block, first block logs)
- conv1 [512, 512]
- t_embedder2
- WaveNet (8 layers)
- res_projection [512, 512]
- final_layer (AdaLN)
- conv2 (output projection)

If any "using random" warnings appear for DiT components:
- Identify the tensor name that failed
- Check if it exists in checkpoint with different name
- Add the correct mapping

Common issues to check:
- Tensor name typos (e.g., "project_layer" vs "proj_layer")
- Missing bias keys (some layers have no bias)
- Shape mismatches from conv vs linear interpretation
  </action>
  <verify>
Run: `grep -c "using random" dit_load.log`
Expected: 0 (zero instances of random fallback for DiT components)
Alternative: `grep "\[DiT\].*random" dit_load.log` should return empty
  </verify>
  <done>No "using random weights" warnings appear in DiT loading output</done>
</task>

<task type="auto">
  <name>Task 3: Run tests and verify output quality</name>
  <files>src/models/s2mel/dit.rs</files>
  <action>
1. Run the full test suite:
```bash
cargo test --release 2>&1 | tail -20
```
Expected: All tests pass

2. Run inference and check output file:
```bash
cargo run --release --bin indextts2 -- --cpu infer \
  --text "Hello, this is a test of the speech synthesis system." \
  --speaker "checkpoints/speaker_ref.wav" \
  --output "output_dit_test.wav"

# Check output file exists and has reasonable size
ls -la output_dit_test.wav
```
Expected: WAV file > 10KB (not empty or trivially small)

3. Check debug output statistics for non-random values:
Look for DiT forward pass debug output showing:
- x_embedder output has non-zero variance
- Attention scores have reasonable range (not all same value)
- Final output has mel-spectrogram-like statistics

If output is still noise/garbage despite weights loading:
- The issue is in forward pass logic, not weight loading
- Document the symptoms for Phase 5+ to address
- This plan's success criteria is weight LOADING, not output quality
  </action>
  <verify>
Run: `cargo test --release 2>&1 | grep -E "(PASSED|FAILED|test result)" | tail -5`
Expected: "test result: ok" with all tests passing
  </verify>
  <done>Tests pass and inference produces non-empty WAV output</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Weight loading verification:
```bash
RUST_LOG=warn cargo run --release --bin indextts2 -- --cpu infer \
  --text "Test" --speaker "checkpoints/speaker_ref.wav" --output "/dev/null" 2>&1 | \
  grep -E "\[DiT\].*random|using random|failed to load" | wc -l
```
Expected: 0

2. skip_in_linear loaded:
```bash
grep "skip_in_linear" dit_load.log
```
Expected: Shows "Loaded skip_in_linear"

3. All 13 blocks loaded:
```bash
grep "transformer blocks" dit_load.log
```
Expected: "Loaded 13 of 13 transformer blocks"

4. Tests pass:
```bash
cargo test --release 2>&1 | grep "test result"
```
Expected: "test result: ok"
</verification>

<success_criteria>
Phase 4 is complete when:
1. DiT loads all 13 transformer blocks from s2mel.safetensors - VERIFIED by log output
2. Weight normalization applied correctly to x_embedder - VERIFIED by loading message
3. Fused QKV tensors split correctly - ALREADY WORKING (verified in research)
4. No "using random weights" warnings appear for DiT - VERIFIED by grep returning 0 matches
5. skip_in_linear loaded for each transformer block - VERIFIED by loading message
6. All tests pass - VERIFIED by cargo test
</success_criteria>

<output>
After completion, create `.planning/phases/04-dit-weights/04-01-SUMMARY.md`
</output>

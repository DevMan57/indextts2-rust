---
phase: 04-dit-weights
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/models/s2mel/dit.rs
autonomous: true
user_setup: []

must_haves:
  truths:
    - "DiT loads all 13 transformer blocks without 'using random weights' warnings"
    - "Weight normalization produces non-zero weights for x_embedder"
    - "Fused QKV split correctly into Q/K/V components"
    - "skip_in_linear weights load from checkpoint for all 13 blocks"
  artifacts:
    - path: "src/models/s2mel/dit.rs"
      provides: "DiTBlock with skip_in_linear field and loading"
      contains: "skip_in_linear"
  key_links:
    - from: "DiTBlock::from_tensors"
      to: "skip_in_linear.weight"
      via: "load_linear"
      pattern: "skip_in_linear.*weight"
---

<objective>
Add skip_in_linear to DiTBlock and verify all DiT weights load without fallback to random initialization.

Purpose: Complete the DiT weight loading so flow matching produces quality mel spectrograms instead of noise. The skip_in_linear component is required for UViT skip connections that concatenate encoder and decoder features. Forward pass usage is deferred to a later phase; this phase only ensures weights LOAD correctly.

Output: DiT that loads all 269 tensors from s2mel.safetensors with zero "using random weights" warnings.
</objective>

<execution_context>
@C:\Users\Henri Smith\.claude-membership/get-shit-done/workflows/execute-plan.md
@C:\Users\Henri Smith\.claude-membership/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase research identifies the gap
@.planning/phases/04-dit-weights/04-RESEARCH.md
@.planning/phases/04-dit-weights/04-CONTEXT.md

# Source file to modify
@src/models/s2mel/dit.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add skip_in_linear to DiTBlock</name>
  <files>src/models/s2mel/dit.rs</files>
  <action>
Add skip_in_linear field to DiTBlock struct and load it from checkpoint:

1. Update DiTBlock struct (around line 769):
```rust
struct DiTBlock {
    norm1: AdaLayerNorm,
    attn: MultiHeadAttention,
    norm2: AdaLayerNorm,
    ff: FeedForward,
    skip_in_linear: Option<Linear>,  // ADD: [512, 1024] for UViT skip connections
}
```

2. Update DiTBlock::new() to initialize skip_in_linear as None (random init path)

3. Update DiTBlock::from_tensors() to load skip_in_linear:
```rust
// After loading ff, add:
let skip_key = format!("{}.skip_in_linear.weight", prefix);
let skip_in_linear = match load_linear(
    tensors,
    &skip_key,
    Some(&format!("{}.skip_in_linear.bias", prefix)),
) {
    Ok(linear) => {
        // Only first block logs
        if prefix.ends_with(".0") {
            eprintln!("  Loaded skip_in_linear [512, 1024]");
        }
        Some(linear)
    }
    Err(_) => {
        tracing::warn!(
            "[DiT] Missing tensor '{}', skip connection disabled",
            skip_key
        );
        None
    }
};
```

4. Update DiTBlock::forward() signature to accept skip parameter but do NOT wire it yet:
```rust
fn forward(&self, x: &Tensor, cond: &Tensor, _skip: Option<&Tensor>) -> Result<Tensor> {
    // skip_in_linear usage is deferred to a later phase
    // For now, just keep the existing forward logic unchanged
    let residual = x.clone();
    let x_normed = self.norm1.forward(&x, cond)?;
    // ... rest unchanged
}
```

Note: The UViT skip connection wiring is deferred per research findings. This task ONLY adds the field and loads the weights. Forward pass integration is a future phase.
  </action>
  <verify>
Run: `cargo build --release 2>&1`
Expected: Compiles with no errors. May show warnings about unused skip_in_linear field (acceptable).
  </verify>
  <done>DiTBlock has skip_in_linear field that loads from checkpoint or warns if missing</done>
</task>

<task type="auto">
  <name>Task 2: Verify all DiT weights load via test suite</name>
  <files>src/models/s2mel/dit.rs</files>
  <action>
Run the existing test suite to verify weight loading works correctly. The tests should cover:
- DiT model creation and weight loading
- No panics from missing weights
- Tensor shape validation

If any tests fail related to DiT weight loading:
1. Check the error message for the specific tensor name
2. Verify tensor exists in checkpoint with expected name
3. Fix any typos in tensor key strings

No new test code needed - existing integration and unit tests cover weight loading validation.
  </action>
  <verify>
Run: `cargo test --release dit`
Expected: All DiT-related tests pass. Zero test failures.
  </verify>
  <done>Test suite passes with no DiT weight loading failures</done>
</task>

<task type="auto">
  <name>Task 3: Run full inference and verify non-empty output</name>
  <files>src/models/s2mel/dit.rs</files>
  <action>
Run full inference to verify the complete pipeline still works after adding skip_in_linear:

```
cargo run --release --bin indextts2 -- --cpu infer \
  --text "Hello, this is a test." \
  --speaker "checkpoints/speaker_ref.wav" \
  --output "output_dit_test.wav"
```

Check:
1. Command completes without error
2. Output WAV file exists and has size > 10KB
3. No "using random weights" warnings appear for DiT components in stderr

Note: This is integration-level verification. If output quality is poor but weights load correctly, the issue is in forward pass logic (not this phase's scope). If earlier phases (Wav2Vec-BERT, GPT) have issues, those would also affect output quality. This task verifies DiT weight LOADING specifically - check stderr for any "[DiT].*random" warnings.

Success for this task means: weights load without fallback warnings, inference completes, file is produced. Output audio quality is not in scope for Phase 4.
  </action>
  <verify>
Run: `cargo run --release --bin indextts2 -- --cpu infer --text "Test" --speaker "checkpoints/speaker_ref.wav" --output "test.wav" 2>&1`
Expected: Command succeeds (exit code 0), output file exists. Check stderr manually for any "[DiT]" warnings mentioning "random".
  </verify>
  <done>Inference completes and produces non-empty WAV output with no DiT random fallback warnings</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Build succeeds:
```
cargo build --release
```
Expected: Exit code 0

2. Tests pass:
```
cargo test --release dit
```
Expected: All tests pass

3. skip_in_linear is in code:
```
grep "skip_in_linear" src/models/s2mel/dit.rs
```
Expected: Multiple matches showing field definition and loading code

4. Inference produces output:
```
cargo run --release --bin indextts2 -- --cpu infer --text "Test" --speaker "checkpoints/speaker_ref.wav" --output "verify.wav"
ls verify.wav
```
Expected: File exists with non-zero size
</verification>

<success_criteria>
Phase 4 is complete when:
1. DiT loads all 13 transformer blocks from s2mel.safetensors - VERIFIED by no random fallback warnings
2. Weight normalization applied correctly to x_embedder - VERIFIED by loading message
3. Fused QKV tensors split correctly - ALREADY WORKING (verified in research)
4. No "using random weights" warnings appear for DiT - VERIFIED by stderr check
5. skip_in_linear loaded for each transformer block - VERIFIED by loading message
6. All tests pass - VERIFIED by cargo test
</success_criteria>

<output>
After completion, create `.planning/phases/04-dit-weights/04-01-SUMMARY.md`
</output>
